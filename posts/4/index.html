
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Questy.org</title>
  <meta name="author" content="Jerald Sheets">

  
  <meta name="description" content="Once you&rsquo;ve got your handy LDAP server authenticating users for login throughout your environment, inevitably you find yourself getting around &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://www.questy.org/posts/4/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Questy.org" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:www.questy.org" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
    <li><a href="/">
        <span class="blue_light">
            Questy.org
        </span>
       
           <span class="blue_dark">
             tech musings and other stuff&#8230;
           </span>
       
    </a></li>
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/about">About me</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2010/08/05/ldap-authentication-for-apache/">LDAP Authentication IV - Apache</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-08-05T16:03:09-05:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Once you&rsquo;ve got your handy LDAP server authenticating users for login throughout your environment, inevitably you find yourself getting around to the question of authentication for all your backend tools/services machines.  Can you authenticate from Apache to that same auth store to reduce administration burden across the environment?</p>

<p>Yes you can.</p>

<p>Recall from part I of this series that we have a server that is serving auth for our mythical &ldquo;Bob.com&rdquo; environment.  Recall also the important info regarding this environment:</p>

<p>Internet domain name:                   bob.com
hostname of the server:                   ldap.bob.com
LDAP Search base:                          dc=bob,dc=com</p>

<p>File:  /etc/openldap/ldap.conf</p>

<p>#</p>

<h1>LDAP Defaults</h1>

<p>#</p>

<p>BASE dc=bob,dc=com
URI ldap://ldap.bob.com
TLS_CACERTDIR /etc/openldap/cacerts</p>

<p>Now, we add to the mix an Apache web server that has an area it wants to secure.  Instead of using the old htpasswd method to create a disk-file containing usernames and password hashes, it would make much more sense to simply point Apache&rsquo;s authentication system at our shiny new LDAP server so we eliminate yet another user/pass system we have to administer.</p>

<p><strong>Apache</strong></p>

<p>As many of you are already aware, Apache offers simple authentication to allow/disallow access to specific shared directories over the web.  The Apache Project has detailed documentation to help you get started <a href="http://httpd.apache.org/docs/2.2/howto/auth.html">here</a>. I&rsquo;ll cover the basics here.</p>

<p>Traditionally, in Apache&rsquo;s config file(s) you specify a directory you wish to have secured via the &ldquo;Directory&rdquo; directive like so:</p>

<blockquote>

> 
> <Directory "/super/secret/directory">
> 
> 

> 
> AllowOverride None
> 
> 

> 
> Options ExecCGI Includes
> 
> 

> 
> Order allow,deny
> 
> 

> 
> Allow from all
> 
> 

> 
> AuthUserFile /secure/passwd/file/location
> 
> 

> 
> AuthType Basic
> 
> 

> 
> AuthName &#8220;Cool Security Name&#8221;
> 
> 

> 
> Require valid-user
> 
> 

> 
> </Directory>
> 
> </blockquote>


<p>You then create your passwd file for Apache with the htpasswd utility, make sure the above path points to it, bounce Apache, and you&rsquo;re authenticating locally.  Problem with this is that every time you need to add a new user to your environment, every instance like this has to be touched individually and you have to add the user (whether by copy/paste or otherwise is irrelevant) in each.</p>

<p>Enter LDAP.</p>

<p>Fortunately, the configuration for such a change is quite easy; Simple textual changes to the httpd.conf to repoint from the local disk file to the LDAP store is all you need.  First, make sure that your LDAP modules are properly loaded into Apache:</p>

<p>LoadModule ldap_module modules/mod_ldap.so</p>

<p>LoadModule authnz_ldap_module modules/mod_authnz_ldap.so</p>

<p>This tells the Apache core to load up these at startup so that the directives you supply in the Directory stanza will be understood.  Next, let&rsquo;s add the appropriate info into the Directory section:</p>

<p><Directory "/super/secret/directory"></p>

<p>AllowOverride None</p>

<p>Options ExecCGI Includes</p>

<p>Order deny,allow</p>

<p>Deny from all</p>

<p>AuthName &ldquo;Cool Security Name&rdquo;</p>

<p>AuthType Basic</p>

<p>AuthBasicProvider ldap</p>

<p>AuthzLDAPAuthoritative Off</p>

<p>AuthLDAPURL ldap://cool.ldap.server/dc=bob,dc=com?uid</p>

<p>AuthLDAPBindDN &ldquo;cn=admin,dc=bob,dc=com&rdquo;</p>

<p>AuthLDAPGroupAttribute memberUid</p>

<p>AuthLDAPGroupAttributeIsDN off</p>

<p>AuthLDAPBindPassword <your_bind_password></p>

<p>Satisfy any</p>

<p></Directory></p>

<p>This simple change (after an Apache restart) should give your Apache server security over that directory, authenticating against LDAP.  Since your LDAP store is POSIX compliant for login, you have a few other things you can leverage in there as well.  Among those, are the &ldquo;Group&rdquo; field.  That&rsquo;s right, instead of going out and adding individuals and/or preventing them, you can specify an entire class of people (say LDAP_Logins for instance) that if the user belongs to that group, suddenly they have access to anything that is authenticating against LDAP.</p>

<p>To add that ability, you can add groups to the stanza above like so:</p>

<p>Require ldap-group cn=mygroup,ou=Group,dc=bob,dc=com</p>

<p>Require ldap-attribute gidNumber=500</p>

<p><em>(you place your group number in place of the &ldquo;500&rdquo; above)</em></p>

<p>Now that you have the magic behind LDAP auth for Apache, you can add this to any Apache web server of the 2.x variety, and do your security centrally.</p>

<p>The ease of addition for new users on your network is now as simple as adding the user to your LDAP store, placing them in the appropriate group.  Once Apache was restarted the very first time to make this work, you never have to restart it for user additions.  It will simply query LDAP, and LDAP will provide the credential response Apache needs to continue forward.</p>

<p>Next time:  Sudoers in LDAP!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2010/02/26/wow-squeeze-for-mac-9-95-a/">Wow, Squeeze for Mac ($9.95)</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-02-26T12:14:04-06:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Wow, Squeeze for Mac ($9.95) “fell off” the @<a href="http://twitter.com/MacHeist">MacHeist</a> truck… get it at a 5-finger discount! <a href="http://MacHeist.com">http://MacHeist.com</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2010/02/10/so-i-just-tied-my-twitter-to/">So, I Just Tied My Twitter to &#8230;</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-02-10T16:12:02-06:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>So, I just tied my Twitter to Buzz&hellip;. Let&rsquo;s see what happens.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2010/01/24/ive-been-waiting-all-42-years/">I&#8217;ve Been Waiting All 42 Years&#8230;</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-01-24T21:24:46-06:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I&rsquo;ve been waiting all 42 years of my life to see this. Founded the year I was born, going to the bowl. #<a href="http://search.twitter.com/search?q=%23saints">saints</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2010/01/13/bah-late-start-work-home/">BAH! Late Start. Work, Home &#8230;</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-01-13T08:01:41-06:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>BAH! Late start. Work, home to get the guitar and then back up to kinship at 7.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2010/01/09/win-a-new-canon-5dmkii-or-270/">Win a New Canon 5DMKII or $270&#8230;</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-01-09T08:30:10-06:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Win a new Canon 5DMKII or $2700 of photo printing/product from @<a href="http://twitter.com/WHCCPro">WHCCPro</a> &amp; Scott Bourne. Pls RT. Info: <a href="http://bit.ly/6Mtx9I">http://bit.ly/6Mtx9I</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/12/29/my-review-of-roku-hd-player-3/">My Review of Roku HD Player</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-12-29T10:15:48-06:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="http://www.roku.com/roku-products">Originally submitted at Roku</a></p>

<p>The best-selling HD Player (as known as Netflix Player by Roku) plays High Definition video and connects to surround sound audio.</p>

<p><a href="http://www.roku.com/roku-products">Roku HD Player</a></p>

<p><strong>Roku Outstanding, Content Scarce</strong></p>

<p>By <strong>cvquesty</strong> from <strong>Atlanta, GA</strong> on <strong>12/29/2009</strong></p>

<p>4out of 5</p>

<p><strong>Pros: </strong>High quality picture, Reliability, Great value, Easy to use, Easy to set up</p>

<p><strong>Cons: </strong>Want more video choices</p>

<p><strong>Best Uses: </strong>Primary TV</p>

<p><strong>Describe Yourself: </strong>Movie buff, Netflix fan, Technophile, Early adopter, Power User</p>

<p>We are on the verge of eliminating Cable TV, thanks to Roku. The only problem left is the dearth of programming choices. There are MANY more online video and audio networks out there all primed and ready to be carried by the likes of a Roku. Give me more programming, and I&rsquo;ll go with you all the way.</p>

<p>I <em>might</em> even pay a monthly subscription if you can get Hulu or Boxee or some other content market deal.</p>

<p>(<a href="http://www.powerreviews.com/legal/terms_of_use.html">legalese</a>)</p>

<p>  *[12/29/2009]: 20091229T1200-0800</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/12/29/ldap-administration-iii-odds-n-ends/">LDAP Administration III – ‘Odds ‘n Ends’</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-12-29T05:17:46-06:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>By now you should have a functional LDAP server, a properly configured client, and the ability to authenticate against your server.  However, the last couple &ldquo;cogs in the wheel&rdquo; are left to manage.</p>

<p>Generally speaking, when you add a user in UNIX-land, part of the process of the adduser command also sets their shell, creates a home directory for them and so forth.  As you may notice, there is no particular method to make this happen in Linux-LDAP.  You just have a store and a tool to manage the store.</p>

<p>Have no fear, it&rsquo;s PAM to the rescue.</p>

<p>As we said in our first installment, the following packages are all that is necessary to have the basic plumbing of LDAP to work:</p>

<p>openldap</p>

<p>openldap-servers</p>

<p>openldap-clients</p>

<p>openldap-devel</p>

<p>While that is true, there are a couple more packages that put the finishing touches on this to make it sing.  Those are:</p>

<p>nss
nss_ldap
nscd</p>

<p>NSS is a glibc mechanism or interface allowing access to the common UNIX databases such as the password or hosts database.  It is most commonly used to provide an interface to both local /etc/passd and /etc/shadow files and usually for the purposes of interfacing with LDAP or NIS.</p>

<p>NSS_LDAP is a set of C library extensions which allows X.500 and LDAP directory servers to be used as a primary source of name service information such as users, hosts, groups, and other such data historically managed via local flat files or a NIS infrastructure.</p>

<p>NSCD is a name services caching daemon that provides a cache for the most common name requests.  While useful in speeding up response to queries, nscd has it&rsquo;s own set of problems.  I&rsquo;ll cover only some of it&rsquo;s usefulness, and you should circumspectly determine whether you will need caching at all based on your organization&rsquo;s size and the size of your serving infrastructure.</p>

<p><strong>Home Directories</strong></p>

<p>First and foremost, to make the login process as pleasurable/smooth an experience as possible, there are some things that we generally do in standard administration practices that ease the user&rsquo;s experience.  Namely, we setup a standard set of configuration and environment files to provide a consistent user experience of the shell.  These are usually their home directory files such as:</p>

<p>.bashrc
.bash_profile
.bash_logout
.vimrc
.mozilla</p>

<p>Usually these are handled in the usual way via the useradd command, which also copies one of everything from the /etc/skel directory to your user&rsquo;s home.</p>

<p>As you can see, simply adding a user to the LDAP store would not give occasion for this to happen.  PAM to the rescue!  PAM contains a module that is their &ldquo;mkhomedir&rdquo; module.  Depending on your architecture, this lives in the /lib or the /lib64 directories under &ldquo;security&rdquo;:</p>

<p>/lib/security/pam_mkhomedir.so
/lib64/security/pam_mkhomedir.so</p>

<p>What these modules do when properly invoked is on the first connection of a user that is validated as a proper user/password combination via LDAP, PAM sees that they have no home directory, and <em>creates the home directory for them just as if you, the administrator had created it with the <strong>adduser </strong>script.</em></p>

<p>This, by far, is one of the handiest modules provided by PAM.</p>

<p><strong>Turning on the PAM</strong></p>

<p>To turn on the mkhomedir facility for your servers and clients, simply do the following:</p>

<p>In /etc/pam.d there are a number of configuration files for handling login defs for varying circumstances.  What we are interested in is <em>system-auth</em>.  System-auth is also sourced by the sshd option, so this will work for both console logins and ssh/remote logins.</p>

<p>The last stanza of the system-auth configuration file is the &ldquo;session&rdquo; section.  On the second-to-last line between the pam_unix and pam_ldap designations, add the following:</p>

<p>session     required     pam_mkhomedir.so</p>

<p>This is a keyword set that tells Linux to load up and perform the functions offered by the pam_mkhomedir module.  Now, whenever you connect to a system configured in this way, it will automatically create the user&rsquo;s skel information and change ownerships to the proper settings so the user can login.</p>

<p><strong>Security</strong></p>

<p>You may note that I also referred to using group-based security.  In LDAP/PAM-land, this is just as simple as the above PAM setup.  Look into the individual system&rsquo;s /etc/security directory for a file called access.conf.  This file allows you to grant/deny access to individual users, groups, and also where they can connect to this machine from.  The syntax is clearly explained in the file itself, but here&rsquo;s an example.</p>

<p>Let&rsquo;s say I only want root, wheel, and the admins group to be able to access a certain system.  let&rsquo;s say they can access this system from anywhere.  Now let&rsquo;s say I also want the backup group to access the same system, but only from one host.  The setup is quite simple.  First, let&rsquo;s allow complete access to the people we wish to be able to connect from everywhere.  At the end of the /etc/security/access.conf file, add the following line:</p>

<p>+: root wheel admins : ALL</p>

<p>This tells the system to add access for root, wheel, and admins from ALL hosts.  Now, let&rsquo;s put in those backup admins, but only allow them to connect from the host we want them to come from:</p>

<p>+: backup : 10.1.10.10</p>

<p>This means the backup group can access this host, but only from the host 10.1.10.10.  There are many other methods of allowing and denying access in this file.  The documentation is contained within the file, so feel free to look through it for more information.</p>

<p>The MOST important line is the last line, however.  After you&rsquo;ve setup all the people you WANT to access the system, that does no good if all access is still left on for everyone, everywhere.  The final line in the file should be to deny all access to anyone else not specified above, and would look like this:</p>

<ul>
<li>: ALL : ALL</li>
</ul>


<p>Simply stated, this removes (or subtracts) all access for ALL other users from ALL other hosts.  This line is evaluated last after the preceding lines are, and will take the preceding lines into account when setting up it&rsquo;s rules in memory.</p>

<p>At the very worst, if you mis-order the lines here, you may not be able to login to the system and will need to boot to single-user mode and then use the article here on this site entitled &ldquo;A Neat Trick&rdquo; to make /etc read/write so you can change the configuration and then reboot back into your system&rsquo;s default runlevel, but if you&rsquo;re careful, this will be quite easy to configure and manage.</p>

<p><strong>Closing Thoughts</strong></p>

<p>I&rsquo;m sure there&rsquo;s a few things I left out, and I will be revising this series at some point in time to allow for any omissions I&rsquo;ve made.  I will also be adding in feature suggestions and will be following this up with a sudo article so you can overlay the &ldquo;on-box&rdquo; security set you&rsquo;d like to see happen in your environment <em>after</em> your LDAP infrastructure is in place.</p>

<p>Feel free to drop me a note if you see anything amiss, and I&rsquo;ll be sure to correct it and give you props.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/12/28/ldap-administration-part-ii/">LDAP Administration – Part II</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-12-28T05:53:02-06:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Ok, so in our previous installment, we got LDAP all configured up from the client perspective.  I&rsquo;ll cover some other client-based niceties such as extra PAM modules and security in our third installment.  For now, back to the show!</p>

<p><strong>The Server</strong></p>

<p>The lightweight Directory Access Protocol (LDAP) gives us tons of things to use to help make the system login/logout process easy to manage and maintain.  The LDAP server runs over the Berkeley Database (BDB) as a data backend, and has a <a href="http://en.wikipedia.org/wiki/LDAP">long history</a> as a protocol/standard.</p>

<p>As we said last time, the server configuration consists of the contents of the /etc/openldap directory with the primary file of interest being the /etc/openldap/slapd.conf file.  The secondary file of interest will be the /etc/ldap.conf file, another server configuration file.</p>

<p><strong>/etc/openldap/slapd.conf</strong></p>

<p>First, we will cover the ldap daemon (slapd) configuration file, /etc/openldap/slapd.conf.  This file is responsible for specifying information regarding what schemas to use, loggin parametwes, database specifications and locations, security, replication, and security grants.</p>

<p>Let&rsquo;s start with a very simple slapd.conf file:</p>

<blockquote># OpenLDAP Server Configuration

# Primary Server Schemas
include         /etc/openldap/schema/core.schema
include         /etc/openldap/schema/cosine.schema
include         /etc/openldap/schema/inetorgperson.schema
include         /etc/openldap/schema/nis.schema
include         /etc/openldap/schema/redhat/autofs.schema

# Logging

loglevel 0
pidfile      /var/run/openldap/slapd.pid
argsfile    /var/run/openldap/slapd.args

# bdb database definitions
database             bdb
suffix                   &#8220;dc=bob,dc=com&#8221;
rootdn                 &#8220;cn=admin,dc=bob,dc=com&#8221;
rootpw                secret
schemacheck    off

# location of the data files
directory              /var/lib/ldap

# Indexes to help speed up queries
index objectClass,uid,uidNumber,gidNumber,memberUid     eq
index cn,mail,surname,givenname                                                eq,subinitial

# Grant users rights to change their own password
access to attrs=userPassword
by self write
by anonymous auth
by dn.base=&#8221;cn=admin,dc=bob,dc=com&#8221; write
by * noneaccess to *
by self write
by dn.base=&#8221;cn=admin,dc=bob,dc=com&#8221; write
by * read</blockquote>


<p>This is a very basic slapd.conf file without TLS security information, without replication information, and without any frills at all.  Recall that our primary goal here is to get a basic LDAP server running and working without any frills.  We want the ting to work, and then we&rsquo;ll add features and security as time goes on.</p>

<p><strong>/etc/ldap.conf</strong></p>

<p>The /etc/ldap.conf file bills itself as the &ldquo;configuration file for the LDAP nameservice switch library and the LDAP PAM module&rdquo;.  While we just configured the operation of the server, we must now put the &ldquo;glue&rdquo; in place so that PAM knows how to ask questions of the LDAP system to know if a user is allowed to login or not.  Again, a very simple /etc/ldap.conf file:</p>

<blockquote># ldap.conf &#8211; simple configuration

# Distinguished name of the search base
base dc=bob,dc=com

# The distinguished name to bind to the server with
binddn cn=admin,dc=bob,dc=com

# Password to bind to the directory with
bindpw secretpassword

# Search TimeLimit
timelimit 120

# bind/connection timelimit
bind_timelimit 120

# idle timelimit
idle_timelimit 3600

# PAM password format
pam_password md5

# Assume no supplemental groups for these named users
nss_initgroups_ignoreusers root,ldap,named,avahi,haldaemon,dbus,radvd,tomcat,radiusd,news,mailman

# Main LDAP configuration piece
uri ldap://ldap.bob.com
ssl no
tls_cacertdir /etc/openldap/cacerts</blockquote>


<p>A couple of notes here.  First, the nss_initgroups_ignoreusers portion can most likely be left out.  This is an artifact (as far as I am aware) of being on a RedHat system as several of these users are defaults on RedHat.  Next:  The timelimits are just sane numbers, nothing special.  Should there be any need for tweaking this, it will be in your own experience across your own environment.</p>

<p>Much like the earlier client configuration file, this serves somewhat the same purpose, but for the PAM system as a client rather than a system itself as a client.</p>

<p><strong>Crank it Up!</strong></p>

<p>At this point, you should be able to start up your server to begin configuring it for use.  In RedHat-land, as many of you already know, this is typically a two-part process.  First, you set the service to start at boot and then you start it up.  First, run the command to set the runlevels in which you want ldap to start:</p>

<blockquote>chkconfig &#8211;level 2345 ldap on</blockquote>


<p>And then use the RedHat tools to start the service up:</p>

<blockquote>/sbin/service ldap start</blockquote>


<p>At this point, you should have a fully functional LDAP server running with no particular schema or setup, ready to take data (in our case, POSIX compliant login information) and serve it out to your infrastructure.</p>

<p><strong>Populating the Database</strong></p>

<p>With the RedHat packages come a myriad of important tools you need to help migrate your current authentication information into the LDAP store.  The location of these helpful perl scripts is: /usr/share/openldap/migration.  Before you use these tools, make sure you edit the <strong><em>migrate_common.ph</em></strong> file in this location to match your environment like so:</p>

<blockquote>$DEFAULT_MAIL_DOMAIN = &#8220;bob.com&#8221;
$DEFAULT_BASE = &#8220;dc=bob,dc=com&#8221;</blockquote>


<p>This file is sourced by all the migration scripts resident in this directory, and will automagically insert these values where necessary.</p>

<p>Next, let&rsquo;s do a trial-run of converting our passwd file in &ldquo;LDAP-ese&rdquo;.  Since you&rsquo;ve already edited the migrate_common.ph, you can directly migrate your /etc/passwd and /etc/group files like so:</p>

<blockquote>_From the /usr/share/openldap/migration directory:_

./migrate_passwd.pl /etc/passwd ./passwd.ldif

_Similarly, convert your groups file as well:_

./migrate_group.pl /etc/group ./group.ldif</blockquote>


<p>What these commands will do is convert your standard /etc/passwd and /etc/group file to <a href="http://en.wikipedia.org/wiki/LDIF">ldif</a>-formatted files for import into your LDAP store.  Let&rsquo;s look at a record for an example:</p>

<blockquote>

> 
> dn: uid=bin,ou=People,dc=best,dc=turner,dc=com
> 
> 

> 
> uid: bin
> 
> 

> 
> cn: bin
> 
> 

> 
> objectClass: account
> 
> 

> 
> objectClass: posixAccount
> 
> 

> 
> objectClass: top
> 
> 

> 
> objectClass: shadowAccount
> 
> 

> 
> userPassword: {crypt}*
> 
> 

> 
> shadowLastChange: 14251
> 
> 

> 
> shadowMax: 99999
> 
> 

> 
> shadowWarning: 7
> 
> 

> 
> loginShell: /sbin/nologin
> 
> 

> 
> uidNumber: 1
> 
> 

> 
> gidNumber: 1
> 
> 

> 
> homeDirectory: /bin
> 
> 

> 
> gecos: bin
> 
> 
dn: uid=bin,ou=People,dc=best,dc=turner,dc=comuid: bincn: binobjectClass: accountobjectClass: posixAccountobjectClass: topobjectClass: shadowAccountuserPassword: {crypt}*shadowLastChange: 14251shadowMax: 99999shadowWarning: 7loginShell: /sbin/nologinuidNumber: 1gidNumber: 1homeDirectory: /bingecos: bin</blockquote>


<p>The LDIF format has a number of self-explanatory fields that you can see correlate to your /etc/passwd file.  There are other fields here that LDAP needs, but are beyond our concern at this point.  We&rsquo;ll come back to these later.</p>

<p>I picked a system-default user just to illustrate the format of the ldif.  This user generally has no password, and thus you cannot login using his credentials.  In the userPassword line above, for a regular login user, you would normally see {crypt} followed by a rather large SHA encrypted string representing the user&rsquo;s hash.</p>

<p>This brings about the question of how you wish to manage your users.  Generally speaking, I allow the local /etc/passwd file manage root and all system-default users (bin, spool, lp, etc.) and all users I add post-installation get placed into LDAP.  In that way, I manage the user centrally from the outset.  I&rsquo;ll be covering how I limit what users are allowed to access what systems in a later article.</p>

<p><strong>Importing the LDIF</strong></p>

<p>Once you have your LDIF, you have some decisions/edits to make.  look through your dumped ldif file.  Remove each stanza relating to the users you <em>do not </em>wish to manage via LDAP.  The resulting LDIF file will be the one we import.  Generally speaking, in a RedHat system I delete everything before UID 500 (which is usually me) and import everything else.</p>

<p>Once your LDIF file is how you want it to look, it&rsquo;s time to import.  Import it using the following command, modifying the search base and admin user to suit your configuration:</p>

<blockquote>_ldapadd -W -x -D &#8220;cn=admin,dc=bob,dc=com&#8221; -W -f passwd.lif_</blockquote>


<p>When you run this command, the LDAP server will churn for a moment (depending on how large your passwd file is) and then will return a clean shell with no errors.</p>

<p><strong>Time to &ldquo;Get your GUI On&rdquo;</strong></p>

<p>At this point, I usually point people toward the excellent Apache Directory Studio available at the <a href="http://directory.apache.org/">Apache Directory Project</a>.  This is a gui directory administration tool that can browse and edit your entire store.  The Apache Foundation describes it like so:</p>

<blockquote>Apache Directory Studio is a complete directory tooling platform intended to be used with any LDAP server however it is particularly designed for use with the ApacheDS. It is an Eclipse RCP application, composed of several Eclipse (OSGi) plugins, that can be easily upgraded with additional ones. These plugins can even run within Eclipse itself.</blockquote>


<p>Apache Directory Studio is available for Windows, Linux, and Mac OSX and is a freely-available Apache 2.0 licensed product.</p>

<p>Once you download and configure the Apache Directory Studio, you should be able to view, browse, edit, and manage all aspects of your LDAP store.</p>

<p>Next time, we will tie PAM into LDAP, work with security and group-based access as well as cover a few &ldquo;odds &amp; ends&rdquo; to help you use your LDAP store in a variety of different ways.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/12/22/ldap-administration-part-i/">LDAP Administration – Part I</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-12-22T10:59:45-06:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>One of the things I&rsquo;ve worked on over the last year is setting up a centralized LDAP server for authentication in a UNIX environment.  My clients range from early RedHat to our current distro of RH5.2 or CentOS5.2.</p>

<p>A huge issue I&rsquo;ve run across while doing this work is that I had to piecemeal the information together from all over the Internet because the grand majority of what I could find out there was either for Windows clients or non-POSIX login authorization.</p>

<p>I plan to tell this story mostly in the context of a RedHat-ish rpm-based distro, and the setup of both the server and a Linux client to tell both sides of the story.  I will use my own terminology to begin, making it very simple to explain precisely the setup we&rsquo;re looking for without getting into a lot of LDAP-ese.  As we go through the setup, I will slowly start to relate my description back to LDAP-ese so you can, once your setup is working, go back to the documentation and determine &ldquo;just what happened here&rdquo;</p>

<p>At the end of the story, I&rsquo;m going to have a LOT of keywords so Google gets a good sampling of this to help someone who may be like I was, looking for a very specific UNIX auth implementation.</p>

<p><strong>Server</strong></p>

<p>One of the big things I needed first was to have the server packages installed.  When I did the original installation, I went a little overboard and downloaded and installed everything from the patch level I used, but the essentials are:</p>

<p>openldap
openldap-servers
openldap-clients
openldap-devel</p>

<p>After getting these installed (via either yum or rpm -i&hellip;whichever is your preference) then you should have a subset of important files and tools lying about around your system.  These will be (in no particular order):</p>

<p>/etc/openldap
/etc/openldap/slapd.conf
/etc/ldap.conf</p>

<p>The /etc/openldap directory houses all the files pertaining to your server piece.  From your certs to the appropriate schemas to an example DB_CONFIG for the LDAP backend (Berkeley DB&hellip;more about these later&hellip;)  The primary file of interest in /etc/openldap will be slapd.conf.  In /etc/ldap.conf, you have the server configuration file.</p>

<p>In my setup, the purposes and configuration of these particular files seemed to be the biggest hinderance to getting everything running as I would expect.  At one moment, there was a config element in /etc/ldap.conf and in another there was one in /etc/openldap/slapd.conf.  It appears there has been some overlap from version to version, and even now you have to take all files together, viewing it all as a single configuration.  That&rsquo;s where we will start.</p>

<p><strong>/etc/ldap.conf</strong></p>

<p>I&rsquo;d say that my first confusing issue was that this file serves different functions depending on whether you are looking at a server or a client.  For the client, it is a simple, short file specifying the server and the ldap URI to use for searches.  In the server context, it is for the LDAP nameservice switch configuration and the LDAP module for PAM.</p>

<p><strong>/etc/openldap/ldap.conf </strong></p>

<p>Let&rsquo;s start with the client config.  I know this is putting the cart before the horse, but it is the simplest part of this procedure.  If we configure it now and utilize it in it&rsquo;s easiest configuration, we know that once resolution and searches are functioning, the server is setup correctly.</p>

<p>First, let&rsquo;s talk about your organization a bit before launching into this configuration.  Recall that our entire purpose at this point is POSIX-compliant user/pass functionality and everything that implies.  I&rsquo;m not looking for a phonebook (what seems to be a large portion of the tutorials out there on the &lsquo;net and in the O&#8217;Reilly LDAP book) and I&rsquo;m not looking to find where employee X sits.  I want user/pass/GECOS, etc. of a POSIX-compliant login.</p>

<p>Most organizations are on the Internet these days.  Let&rsquo;s take my mythical company &ldquo;Bob.com&rdquo;.  Bob&rsquo;s company, Bob.com has a website and all the standard DNS resolution and email and the like for Bob.com is already working perfectly.  It already has a nifty website driving tons of customers to Bob&rsquo;s company.  As for the infrastructure of UNIX logins and passwords, the ONLY THING that Bob.com and LDAP have in common is that their bits and bytes are traveling over the same wires as Bob.com&rsquo;s Internet traffic.  That&rsquo;s where the connection ends.  When we start talking about the naming in the LDAP space, even though Bob.com is valid in the Internet as well as the LDAP world, they have absolutely nothing to do with one another from a technical perspective.</p>

<p>In LDAP-land, Bob.com is the name of the company we will be serving.  So, think of this as the top of your tree from which all the other branches will grow.  Bob.com is your organization.  It is also the top of your tree.  This is a <strong><em>conceptual</em></strong> designation.</p>

<p>We will be installing the LDAP server on a piece of server hardware hanging in a rack.  This server will have a DNS hostname, and will be called ldap.bob.com.  This has absolutely nothing to do with LDAP-land.  This is simply the every day server naming and numbering like you would do for a new name/app/web server and the like.</p>

<p>The top of our <em>conceptual</em> tree in our organization is the bob.com <strong><em>base</em></strong> name.  In LDAP-land, we refer to this as your &ldquo;<strong><em>search base</em></strong>&rdquo;.  This is the name root from which all things flow.  Like an OU in active directory or a root filesystem in UNIX, everything happens under this.  So, for our LDAP-land based conceptual idea of our organization, we will have a <em>base distinguished name</em> of Bob.com.  In LDAP-ese, we refer to a base by it&rsquo;s separate parts.  In the case of the base name (for our purposes) these separate parts are known as &ldquo;domain components&rdquo;.  This, should you choose an LDAP name space to match your Internet name space, is the sole point where these two worlds converge.  Bob.com is an Internet domain name while the LDAP-ese separations of the search base are called &ldquo;domain components&rdquo;.</p>

<p>Let&rsquo;s see what this looks like:</p>

<p>Internet domain name:                   bob.com
hostname of the server:                   ldap.bob.com
LDAP Search base:                          dc=bob,dc=com</p>

<p>If you remember some of your DNS-fu, you&rsquo;ll recall that the host/domain portions of the Internet name have significance in IP-Address land, but that is outside the scope of our little discussion here.  The important thing for you to know is that bob.com is an Internet-based domain name that can be resolved in your browser of choice to a location on the Internet for your viewing pleasure.  The LDAP name space of dc=bob,dc=com is an LDAP-formatted representation of the search base of your organization conceptually referred to as Bob.com.</p>

<p>I know that was painful, but the distinction is paramount to proper understanding of this process, how it is named, and how it is used.</p>

<p>So, let&rsquo;s take our client configuration and give it a whirl&hellip;</p>

<p><strong>Configuring a Client</strong></p>

<p>Simply stated, the client only needs to know three things.  First, it needs to know our base conceptual name (or search base), an Internet-formatted <a href="http://en.wikipedia.org/wiki/Uniform_Resource_Identifier">URI</a> to know how to get to the host that has this storehouse of information, and the OS itself needs to know to look at LDAP for this information rather than local files.  Let&rsquo;s look at a client machine&rsquo;s local file:</p>

<p>File:  /etc/openldap/ldap.conf</p>

<p>#</p>

<h1>LDAP Defaults</h1>

<p>#</p>

<p>BASE dc=bob,dc=com
URI ldap://ldap.bob.com
TLS_CACERTDIR /etc/openldap/cacerts</p>

<p>That&rsquo;s really all there is.  The search base and the URI to find the server.  You already know about the file that tells UNIX where to look for information.  It is the file <strong>/etc/nsswitch.conf</strong></p>

<p>This file contains mappings regarding what the system should look at for which services.  The file is in the format:</p>

<p>service:     location1 location2 location3&hellip;</p>

<p>You can have as many locations as you need for UNIX to search, but we&rsquo;re only going to worry about two.  local files and the LDAP store.  In the /etc/nsswitch.conf file, you will have three lines for authentication we are concerned with.  They will look like so:</p>

<blockquote>passwd:     files
shadow:    files
group:        files</blockquote>


<p>This essentially tells the system  that for passwords, password hashes, and groups that you should look at the local files.  Pretty straightforward.  However, to point us at the LDAP server for this information, you need only change this file in the following way:</p>

<blockquote>passwd:     files ldap
shadow:    files ldap
group:        files ldap</blockquote>


<p>What this will do is check the local files for a user and then the LDAP store for that user.  If they do not exist locally, they will resolve from LDAP.  The caveat here is that the user you&rsquo;re trying to login with for testing LDAP should not already exist on the client system.  If it already does, you have a possible issue in that things will work, and you&rsquo;ll never know if you&rsquo;re resolving from local files or LDAP.  I&rsquo;ll show you how to handle this later.</p>

<p>That&rsquo;s it for the client.  Now we have a client configured to shout at ldap.bob.com using the search base of dc=bob,dc=com looking for password, shadow, and group information for POSIX compliant logins on your client host.</p>

<p>Next time, we&rsquo;ll start setting up the server.</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="5">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="3">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2015/01/08/moving-my-tech-content-to-github/">Moving my Tech Content to GitHub</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/11/19/puppetcamp-atlanta/">PuppetCamp Atlanta</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/09/23/puppetconf-2014/">PuppetConf 2014</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/09/11/southeast-puppet-users-group-september/">Southeast Puppet User&#8217;s Group September</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/06/11/toolbox-grows/">The Toolbox Grows&#8230;</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/cvquesty">@cvquesty</a> on GitHub
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'cvquesty',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>



<section class="googleplus">
  <h1>
    <a href="https://plus.google.com/cvquesty?rel=author">
      <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h1>
</section>



<section>
  <h1>Coderwall</h1>
  <ul id="cw_badges">
    <li class="loading">Status updating&#8230;</li>
  </ul>

  <script type="text/javascript">
    var coderwall = (function(){
      function render(options, badges){
        var fragment = '',
            t = $(options.target)[0],
            height = 65,
            width = 65,
            index;

        for (index in badges) {
          fragment += '<a class="cw_badge"title="' + badges[index].description + '" href="http://coderwall.com/' + options.user + '">';
          fragment +=   '<img alt="' + badges[index].description + '" height="' + width + '" width="' + height + '" src="' + badges[index].badge + '"/>';
          fragment += '</a>';
        }

        t.innerHTML = fragment;
      }
      return {
        showBadges: function(options){
          $.ajax({
              url: 'http://coderwall.com/' + options.user + '.json?callback=?'
            , type: 'jsonp'
            , error: function (err) { $(options.target + ' li.loading').addClass('error').text("Error loading feed"); }
            , success: function(res) {
                render(options, res.data.badges);
            }
          });
        }
      };
    })();

    $.domReady(function(){
      if (!window.jXHR){
        var jxhr = document.createElement('script');
        jxhr.type = 'text/javascript';
        jxhr.src = '/javascripts/libs/jXHR.js';
        var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(jxhr, s);
      }
      if (!window.$){
        var b = document.createElement('script');
        b.type = 'text/javascript';
        b.src = '/javascripts/ender.js';
        var sc = document.getElementsByTagName('script')[0];
        sc.parentNode.insertBefore(jxhr, s);
      }
      coderwall.showBadges({
        user: 'cvquesty',
        target: '#cw_badges'
      });
    });
  </script>
  <style type="text/css">
    .cw_badge img {
      padding: 5px;
      border: 0 none !important;
      -moz-box-shadow: none !important;
      -webkit-box-shadow: none !important;
      -o-box-shadow: none !important;
      box-shadow: none !important;
    }
  </style>
</section>


  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - Jerald Sheets -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
